---
title: Rare LolBAS Command Stacking
submission_date: 2020/05/04
information_domain: 'Host'
platforms:
  - Windows
subtypes:
  - Process
analytic_types:
  - TTP
contributors:
  - MITRE
id: CAR-2020-05-003
description: |-
  Description text goes here
coverage:
  - technique: T1012
    tactics:
      - TA0007
    coverage: Low
  - technique: T1112
    tactics:
      - TA0005
    coverage: Low
  - technique: T1547
    tactics:
      - TA0003
    subtechniques:
      - T1547.001
    coverage: Low
  - technique: T1574
    tactics:
      - TA0003
      - TA0004
    subtechniques:
      - T1574.011
    coverage: Low
implementations:
  - name: LolBAS Rare Commands
    description: This Splunk query looks for stacked instances of rare LolBAS commands being executed.
    code: |-
      index=__your_sysmon_index__ EventCode=1 (process = At.exe OR process = Atbroker.exe OR process = Bash.exe OR process = Bitsadmin.exe OR process = Certutil.exe OR process = Cmd.exe OR process = Cmdkey.exe OR process = Cmstp.exe OR process = Control.exe OR process = Csc.exe OR process = Cscript.exe OR process = Dfsvc.exe OR process = Diskshadow.exe OR process = Dnscmd.exe OR process = Esentutl.exe OR process = Eventvwr.exe OR process = Expand.exe OR process = Extexport.exe OR process = Extrac32.exe OR process = Findstr.exe OR process = Forfiles.exe OR process = Ftp.exe OR process = Gpscript.exe OR process = Hh.exe OR process = Ie4uinit.exe OR process = Ieexec.exe OR process = Infdefaultinstall.exe OR process = Installutil.exe OR process = Jsc.exe OR process = Makecab.exe OR process = Mavinject.exe OR process = Microsoft.Workflow.r.exe OR process = Mmc.exe OR process = Msbuild.exe OR process = Msconfig.exe OR process = Msdt.exe OR process = Mshta.exe OR process = Msiexec.exe OR process = Odbcconf.exe OR process = Pcalua.exe OR process = Pcwrun.exe OR process = Presentationhost.exe OR process = Print.exe OR process = Reg.exe OR process = Regasm.exe OR process = Regedit.exe OR process = Register-cimprovider.exe OR process = Regsvcs.exe OR process = Regsvr32.exe OR process = Replace.exe OR process = Rpcping.exe OR process = Rundll32.exe OR process = Runonce.exe OR process = Runscripthelper.exe OR process = Sc.exe OR process = Schtasks.exe OR process = Scriptrunner.exe OR process = SyncAppvPublishingServer.exe OR process = Tttracer.exe OR process = Verclsid.exe OR process = Wab.exe OR process = Wmic.exe OR process = Wscript.exe OR process = Wsreset.exe OR process = Xwizard.exe OR process = Advpack.dll OR process = Comsvcs.dll OR process = Ieadvpack.dll OR process = Ieaframe.dll OR process = Mshtml.dll OR process = Pcwutl.dll OR process = Setupapi.dll OR process = Shdocvw.dll OR process = Shell32.dll OR process = Syssetup.dll OR process = Url.dll OR process = Zipfldr.dll OR process = Appvlp.exe OR process = Bginfo.exe OR process = Cdb.exe OR process = csi.exe OR process = Devtoolslauncher.exe OR process = dnx.exe OR process = Dxcap.exe OR process = Excel.exe OR process = Mftrace.exe OR process = Msdeploy.exe OR process = msxsl.exe OR process = Powerpnt.exe OR process = rcsi.exe OR process = Sqler.exe OR process = Sqlps.exe OR process = SQLToolsPS.exe OR process = Squirrel.exe OR process = te.exe OR process = Tracker.exe OR process = Update.exe OR process = vsjitdebugger.exe OR process = Winword.exe OR process = Wsl.exe OR process = CL_Mutexverifiers.ps1 OR process = CL_Invocation.ps1 OR process = Manage-bde.wsf OR process = Pubprn.vbs OR process = Slmgr.vbs OR process = Syncappvpublishingserver.vbs OR process = winrm.vbs OR process = Pester.bat)|eval CommandLine=lower(CommandLine)|eventstats count(process) as procCount by process|eventstats avg(procCount) as avg stdev(procCount) as stdev|eval lowerBound=(avg-stdev*1.5)|eval isOutlier=if((procCount < lowerBound),1,0)|where isOutlier=1|table host, Image, ParentImage, CommandLine, ParentCommandLine, procCount
    type: Splunk
    data_model: Sysmon native
unit_tests: 
  - description: |-
